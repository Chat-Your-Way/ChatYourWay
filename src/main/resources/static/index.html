<!DOCTYPE html>
<html lang="en">
<head>
  <title>WebSocket Chat Test Client</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<div>
  <h1>WebSocket Chat Test Client</h1>

  <p style="font-style: italic">
    Connect to WebSocket [http://localhost/chat?Authorization=Bearer {jwt_token}]
  </p>
  <div>
    <label for="jwtToken">
      <input type="text" id="jwtToken" placeholder="Enter JWT Token">
    </label>

    <button onclick="initializeWebSocket()">Connect</button>
  </div>

  <p style="font-style: italic">
    Subscribe to topic [/topic/{id}]
  </p>
  <div>

    <label for="subscribeToTopic">
      <input type="text" id="subscribeToTopic" placeholder="Enter topic id">
    </label>

    <button onclick="subscribeToTopic()">Subscribe</button>
  </div>

  <div id="notification"></div>
  <br/>


  <div id="topics"></div>
  <br/>


  <br/>
  <br/>

  <div id="messages"></div>

</div>

<script>
  const subToTopicDest = '/topic/';
  const subToError = '/user/specific/error';
  const subToNotificationDest = '/user/specific/notify/';
  const subToAllTopicsDest = '/user/specific/notify/topics';
  const sendToPublicTopicDest = "/app/topic/public/";
  const sendToPrivateTopicDest = "/app/topic/private/";
  const getHistoryTopicDest = "/app/history/topic/";
  const sendIsTypingDest = "/app/typing"

  const tokenType = 'Bearer';
  let typingTimer;
  let isTyping = false;

  let socket = null;
  let stompClient = null;
  let reconnectDelay = 1000;

  function initializeWebSocket() {
    const jwtToken = document.getElementById('jwtToken').value;
    socket = new SockJS('/chat?Authorization=' + tokenType + ' ' + jwtToken);
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);

        subscribeToMessageNotification();
        subscribeToContactsNotification();
        subscribeToTopicsNotification();
    }, function (error) {
        console.error('Connection error: ' + error);
        setTimeout(initializeWebSocket, reconnectDelay);
    });

    socket.onclose = function(event) {
        console.log('Connection closed: ' + event.code + ' - ' + event.reason);
        setTimeout(initializeWebSocket, reconnectDelay);
    };
}


  function subscribeToTopic() {
    let topicId = document.getElementById('subscribeToTopic').value;

    if (topicId.trim() === '') {
      console.log('topicId is empty');
      stompClient.subscribe(subToTopicDest, function (messages) {
        let parseMessage = JSON.parse(messages.body);
      });
    } else {
      stompClient.subscribe(subToTopicDest + topicId, function (messages) {
        let parseMessage = JSON.parse(messages.body);
      });
    }
  }

  function showMessage(message) {
    let response = document.getElementById('messages');
    response.innerText += ('>>> ' + JSON.stringify(message) + '\n');
  }

  function showNotification(notificationMessage) {
    let response = document.getElementById('notification');
    response.innerText = JSON.stringify(notificationMessage);
  }


  function subscribeToMessageNotification() {
    stompClient.subscribe(subToNotificationDest + 'messages', function (messages) {
      let notificationMessage = JSON.parse(messages.body);
      console.log(notificationMessage);
      showNotification(notificationMessage);
    });
  }

  function subscribeToContactsNotification() {
    stompClient.subscribe(subToNotificationDest + 'contacts', function (messages) {
      let notificationMessage = JSON.parse(messages.body);
      console.log(notificationMessage);
      showNotification(notificationMessage);
    });
  }

  function subscribeToTopicsNotification() {
    stompClient.subscribe(subToNotificationDest + 'topics', function (messages) {
      let notificationMessage = JSON.parse(messages.body);
      console.log(notificationMessage);
      showNotification(notificationMessage);
    });
  }

  function subscribeToError() {
    stompClient.subscribe(subToError, function (messages) {
      let errorMessage = JSON.parse(messages.body);
      console.log(errorMessage);
      showMessage(errorMessage);
    });
  }

  function sendTyping(isTyping) {
    stompClient.send(sendIsTypingDest + '/' + isTyping, {});
  }

  document.addEventListener('keydown', function() {
    if (!isTyping) {
      isTyping = true;
      sendTyping(isTyping);
    }

    clearTimeout(typingTimer);
    typingTimer = setTimeout(function() {
      isTyping = false;
      sendTyping(isTyping);
    }, 2000);
  });

</script>
</body>
</html>